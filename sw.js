const CACHE_NAME="make-your-stories-v2",RUNTIME_CACHE="runtime-cache-v2",IMAGE_CACHE="image-cache-v2",API_CACHE="api-cache-v2",PRECACHE_ASSETS=["/","/index.html","/app.bundle.js","/manifest.json","/images/logo.png","/images/icon-192x192.png","/images/icon-512x512.png"];async function networkFirstStrategy(e,t){try{const n=await fetch(e);return n&&200===n.status&&((await caches.open(t)).put(e,n.clone()),e.url.includes("/v1/stories")&&cacheStoryImages(n.clone())),n}catch(t){console.log("Network request failed, trying cache:",e.url);const n=await caches.match(e);if(n)return console.log("Returning cached response for:",e.url),n;if(e.url.includes("/v1/stories"))return new Response(JSON.stringify({error:!1,message:"Offline - showing cached data",listStory:[]}),{headers:{"Content-Type":"application/json"}});throw t}}async function cacheStoryImages(e){try{const t=(await e.json()).listStory||[],n=await caches.open(IMAGE_CACHE);for(const e of t)if(e.photoUrl)try{const t=await fetch(e.photoUrl);t.ok&&await n.put(e.photoUrl,t)}catch(t){console.log("Failed to cache image:",e.photoUrl)}}catch(e){}}async function cacheFirstStrategy(e,t){const n=await caches.match(e);if(n)return updateCache(e,t),n;try{const n=await fetch(e);return n&&200===n.status&&(await caches.open(t)).put(e,n.clone()),n}catch(t){if(console.error("Fetch failed for:",e.url,t),"navigate"===e.mode)return(await caches.open(CACHE_NAME)).match("/index.html");if("image"===e.destination||e.url.match(/\.(jpg|jpeg|png|gif|webp|svg)$/i)||e.url.includes("story-api.dicoding.dev"))return new Response('<svg width="400" height="300" xmlns="http://www.w3.org/2000/svg">\n          <rect width="400" height="300" fill="#e0e0e0"/>\n          <text x="50%" y="50%" font-family="Arial" font-size="18" fill="#757575" text-anchor="middle" dy="0">\n            Gambar tidak tersedia\n          </text>\n          <text x="50%" y="60%" font-family="Arial" font-size="14" fill="#9e9e9e" text-anchor="middle" dy="0">\n            (Mode Offline)\n          </text>\n        </svg>',{headers:{"Content-Type":"image/svg+xml","Cache-Control":"no-store"}});throw t}}async function updateCache(e,t){try{const n=await fetch(e);n&&200===n.status&&(await caches.open(t)).put(e,n.clone())}catch(e){return null}}async function syncStories(){try{console.log("Background sync: syncing stories")}catch(e){console.error("Background sync failed:",e)}}self.addEventListener("install",(e=>{e.waitUntil(caches.open(CACHE_NAME).then((e=>e.addAll(PRECACHE_ASSETS))).then((()=>self.skipWaiting())).catch((e=>{console.error("Precaching failed:",e)})))})),self.addEventListener("activate",(e=>{const t=[CACHE_NAME,RUNTIME_CACHE,IMAGE_CACHE,API_CACHE];e.waitUntil(caches.keys().then((e=>Promise.all(e.map((e=>{if(!t.includes(e))return console.log("Deleting old cache:",e),caches.delete(e)}))))).then((()=>self.clients.claim())))})),self.addEventListener("fetch",(e=>{const{request:t}=e,n=new URL(t.url);"GET"===t.method&&"chrome-extension:"!==n.protocol&&(n.pathname.includes("/images/")||n.pathname.match(/\.(jpg|jpeg|png|gif|webp|svg)$/i)?e.respondWith(cacheFirstStrategy(t,IMAGE_CACHE)):n.href.includes("/v1/stories")||n.href.includes("/v1/login")||n.href.includes("/v1/register")?e.respondWith(networkFirstStrategy(t,API_CACHE)):e.respondWith(cacheFirstStrategy(t,CACHE_NAME)))})),self.addEventListener("push",(e=>{let t={};try{t=e.data?JSON.parse(e.data.text()):{}}catch(n){console.warn("Invalid JSON, using fallback"),t={title:"New Notification",body:e.data?.text()||"You have a new message"}}const n=t.title||"Make Your Stories",i={body:t.body||t.options?.body||"Notification received",icon:"/images/icon-192x192.png",badge:"/images/icon-96x96.png",data:t.data||{},vibrate:[200,100,200],tag:"story-notification",requireInteraction:!1};e.waitUntil(self.registration.showNotification(n,i))})),self.addEventListener("notificationclick",(e=>{e.notification.close();const t=e.notification.data?.url||"/";e.waitUntil(clients.matchAll({type:"window",includeUncontrolled:!0}).then((e=>{const n=e.find((e=>e.url.includes(t)&&"focus"in e));return n?n.focus():clients.openWindow(t)})))})),self.addEventListener("sync",(e=>{"sync-stories"===e.tag&&e.waitUntil(syncStories())}));